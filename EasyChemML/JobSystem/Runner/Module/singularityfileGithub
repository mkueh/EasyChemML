Bootstrap: docker
From: nvidia/cuda:12.2.0-devel-ubuntu20.04
Stage: spython-base

%environment
    export RUST_BACKTRACE=1

%post

sed -i 's/video:x:44:/video:x:485:/' /etc/group
ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

ln -s /usr/local/cuda/lib64/stubs/libcuda.so /usr/local/cuda/lib64/stubs/libcuda.so.1 \
    && echo "/usr/local/cuda/lib64/stubs" > /etc/ld.so.conf.d/z-cuda-stubs.conf \
    && ldconfig

apt-get update -y && apt-get upgrade -y
apt-get install curl nano wget zip git build-essential -y

cd /opt
mkdir /miniconda3

PATH="/opt/miniconda3/bin:${PATH}"
PATH="/opt/miniconda3/bin:${PATH}"
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
mkdir /opt/.conda
bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda3/
rm -f Miniconda3-latest-Linux-x86_64.sh
echo PATH="/opt/miniconda3/bin":$PATH >> .bashrc
echo "export PATH=$PATH:/opt/miniconda3/bin" >> /etc/profile
/opt/miniconda3/bin/conda --version

/opt/miniconda3/bin/conda init

curl https://sh.rustup.rs -sSf | bash -s -- -y

#echo 'source $HOME/.cargo/env' >> $HOME/.bashrc
#/bin/bash -c "source $HOME/.cargo/env"
PATH="$PATH:/$HOME/.cargo/bin"

pip install setuptools-rust

cd /opt
git clone https://github.com/mkueh/EasyChemML.git
cd EasyChemML
pip install ./

mkdir /workdir
mkdir /datasets
cd /workdir

%environment
export TZ=Europe/Berlin
export PATH="/opt/miniconda3/bin:${PATH}"
export NOTVISIBLE="in users profile"